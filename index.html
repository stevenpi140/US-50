<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>美國五十州填色空白地圖（藍/紅猜測）</title>
  <style>
    :root {
      --bg: #0b0c0f;
      --panel: #151822;
      --text: #e7e9ee;
      --muted: #9aa3b2;
      --neutral: #e6e8ed;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, "PingFang TC", Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
      display: grid;
      grid-template-rows: auto 1fr auto;
    }
    header, footer { padding: 12px 16px; background: var(--panel); border-bottom: 1px solid #212536; }
    header { position: sticky; top: 0; z-index: 2; }
    footer { border-top: 1px solid #212536; border-bottom: none; }

    .toolbar {
      display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
    }
    .toolbar .sep { width: 1px; height: 28px; background: #2a3042; margin: 0 4px; }
    .btn {
      appearance: none; border: 1px solid #2a3042; background: #0f1320; color: var(--text);
      padding: 8px 10px; border-radius: 10px; font-size: 14px; cursor: pointer;
    }
    .btn:hover { filter: brightness(1.1); }
    .btn:active { transform: translateY(1px); }
    .btn.blue { border-color: #2b3f66; }
    .btn.red { border-color: #5a2a36; }
    .btn.neutral { border-color: #394157; }
    .btn.primary { border-color: #3b82f6; background: #0f172a; }

    .legend {
      display: inline-flex; gap: 10px; align-items: center; padding-left: 6px; color: var(--muted);
    }
    .swatch { width: 16px; height: 16px; border-radius: 4px; border: 1px solid #0006; display: inline-block; vertical-align: middle; }
    .swatch.blue { background: #3b82f6; }
    .swatch.red  { background: #ef4444; }
    .swatch.neutral { background: var(--neutral); }

    #wrap { display: grid; grid-template-columns: 320px 1fr; gap: 16px; padding: 16px; }
    @media (max-width: 960px) { #wrap { grid-template-columns: 1fr; } }

    .panel {
      background: var(--panel); border: 1px solid #212536; border-radius: 12px; padding: 12px; height: fit-content;
    }
    .panel h3 { margin: 6px 0 10px; font-size: 16px; color: var(--text); }
    .panel p, .panel li { color: var(--muted); font-size: 14px; line-height: 1.5; }
    .panel ul { margin: 8px 0 0 18px; }

    /* SVG map */
    #map {
      background: #0d111a; border: 1px solid #212536; border-radius: 12px; padding: 12px;
      display: grid; place-items: center;
    }
    svg { width: 100%; height: auto; max-width: 1200px; aspect-ratio: 16/10; display: block; }
    .state { fill: var(--neutral); stroke: #1f2434; stroke-width: .6; cursor: pointer; }
    .state:hover { filter: brightness(0.95); stroke-width: 1; }
    .state.blue { fill: #3b82f6; }
    .state.red  { fill: #ef4444; }

    .label { font: 10px/1.1 ui-sans-serif, system-ui; fill: #f7fafc; paint-order: stroke; stroke: #0b0c0f; stroke-width: 2; pointer-events: none; text-anchor: middle; }

    .tooltip {
      position: fixed; pointer-events: none; padding: 6px 8px; border-radius: 8px; font-size: 12px;
      background: #0b1220; color: #e5e7eb; border: 1px solid #24324a; box-shadow: 0 8px 24px #0006;
      transform: translate(-50%, calc(-100% - 10px)); display: none; z-index: 5;
    }

    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; }
    .stat { background: #0d1322; border: 1px solid #212536; border-radius: 10px; padding: 8px; text-align: center; }
    .stat .n { font-size: 18px; font-weight: 700; display: block; margin-top: 2px; }

    .kbd { font: 11px mono, ui-monospace, SFMono-Regular; padding: 3px 6px; border-radius: 6px; border: 1px solid #2a3042; background: #0d1322; color: #cbd5e1; }
    .link { color: #93c5fd; text-decoration: none; }
  </style>
</head>
<body>
  <header>
    <div class="toolbar" role="group" aria-label="工具列">
      <button id="modeCycle" class="btn primary" title="點擊切換：中立→藍→紅">模式：點擊循環</button>
      <button id="modeBrush" class="btn" title="選取顏色後點州填色">模式：刷色</button>
      <span class="sep"></span>
      <button id="pickBlue" class="btn blue" title="刷色：藍">刷藍</button>
      <button id="pickRed"  class="btn red" title="刷色：紅">刷紅</button>
      <button id="pickNeutral" class="btn neutral" title="刷色：清除">清除</button>
      <span class="sep"></span>
      <button id="resetBtn" class="btn" title="清空所有上色">全部清空</button>
      <button id="labelsBtn" class="btn" title="顯示或隱藏縮寫">顯示縮寫</button>
      <button id="exportBtn" class="btn" title="匯出 PNG">匯出PNG</button>
      <span class="legend" aria-hidden="true">
        <span class="swatch neutral"></span> 空白
        <span class="swatch blue"></span> 藍
        <span class="swatch red"></span> 紅
      </span>
    </div>
  </header>

  <div id="wrap">
    <aside class="panel" aria-label="說明">
      <h3>使用說明</h3>
      <ul>
        <li>點擊州域切換顏色：中立→藍→紅（或改為「刷色」模式）。</li>
        <li>右鍵點州可清除該州顏色。</li>
        <li>按「顯示縮寫」標註州縮寫，便於點選。</li>
        <li>進度自動暫存於瀏覽器，重新整理仍保留。</li>
      </ul>
      <div class="stats" aria-label="統計">
        <div class="stat">
          <div>已上色</div>
          <span id="filledN" class="n">0</span>
        </div>
        <div class="stat">
          <div>藍</div>
          <span id="blueN" class="n">0</span>
        </div>
        <div class="stat">
          <div>紅</div>
          <span id="redN" class="n">0</span>
        </div>
      </div>
      <p style="margin-top:10px">鍵盤捷徑：<span class="kbd">B</span> 藍，<span class="kbd">R</span> 紅，<span class="kbd">N</span> 清除，<span class="kbd">L</span> 標註縮寫。</p>
      <p>資料來源：<a class="link" href="https://github.com/topojson/us-atlas" target="_blank" rel="noopener">us-atlas TopoJSON</a></p>
    </aside>

    <main id="map" aria-label="美國五十州地圖">
      <svg id="svg" viewBox="0 0 960 600" role="img" aria-labelledby="title desc">
        <title id="title">美國五十州填色空白地圖</title>
        <desc id="desc">點擊各州以標示為藍色或紅色</desc>
        <defs>
          <filter id="drop">
            <feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="#000" flood-opacity="0.3"/>
          </filter>
        </defs>
        <g id="states" filter="url(#drop)"></g>
        <g id="labels" style="display:none"></g>
      </svg>
      <div id="tooltip" class="tooltip" role="status" aria-live="polite"></div>
    </main>
  </div>

  <footer>
    <small style="color:var(--muted)">互動地圖僅供教學與測驗使用。未含任何選舉結果資料。</small>
  </footer>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script>
  (function() {
    const svg = d3.select('#svg');
    const gStates = d3.select('#states');
    const gLabels = d3.select('#labels');
    const tooltip = d3.select('#tooltip');

    const stateMeta = new Map(Object.entries({
      "01": {abbr:"AL", name:"Alabama"},
      "02": {abbr:"AK", name:"Alaska"},
      "04": {abbr:"AZ", name:"Arizona"},
      "05": {abbr:"AR", name:"Arkansas"},
      "06": {abbr:"CA", name:"California"},
      "08": {abbr:"CO", name:"Colorado"},
      "09": {abbr:"CT", name:"Connecticut"},
      "10": {abbr:"DE", name:"Delaware"},
      "12": {abbr:"FL", name:"Florida"},
      "13": {abbr:"GA", name:"Georgia"},
      "15": {abbr:"HI", name:"Hawaii"},
      "16": {abbr:"ID", name:"Idaho"},
      "17": {abbr:"IL", name:"Illinois"},
      "18": {abbr:"IN", name:"Indiana"},
      "19": {abbr:"IA", name:"Iowa"},
      "20": {abbr:"KS", name:"Kansas"},
      "21": {abbr:"KY", name:"Kentucky"},
      "22": {abbr:"LA", name:"Louisiana"},
      "23": {abbr:"ME", name:"Maine"},
      "24": {abbr:"MD", name:"Maryland"},
      "25": {abbr:"MA", name:"Massachusetts"},
      "26": {abbr:"MI", name:"Michigan"},
      "27": {abbr:"MN", name:"Minnesota"},
      "28": {abbr:"MS", name:"Mississippi"},
      "29": {abbr:"MO", name:"Missouri"},
      "30": {abbr:"MT", name:"Montana"},
      "31": {abbr:"NE", name:"Nebraska"},
      "32": {abbr:"NV", name:"Nevada"},
      "33": {abbr:"NH", name:"New Hampshire"},
      "34": {abbr:"NJ", name:"New Jersey"},
      "35": {abbr:"NM", name:"New Mexico"},
      "36": {abbr:"NY", name:"New York"},
      "37": {abbr:"NC", name:"North Carolina"},
      "38": {abbr:"ND", name:"North Dakota"},
      "39": {abbr:"OH", name:"Ohio"},
      "40": {abbr:"OK", name:"Oklahoma"},
      "41": {abbr:"OR", name:"Oregon"},
      "42": {abbr:"PA", name:"Pennsylvania"},
      "44": {abbr:"RI", name:"Rhode Island"},
      "45": {abbr:"SC", name:"South Carolina"},
      "46": {abbr:"SD", name:"South Dakota"},
      "47": {abbr:"TN", name:"Tennessee"},
      "48": {abbr:"TX", name:"Texas"},
      "49": {abbr:"UT", name:"Utah"},
      "50": {abbr:"VT", name:"Vermont"},
      "51": {abbr:"VA", name:"Virginia"},
      "53": {abbr:"WA", name:"Washington"},
      "54": {abbr:"WV", name:"West Virginia"},
      "55": {abbr:"WI", name:"Wisconsin"},
      "56": {abbr:"WY", name:"Wyoming"}
      // 11=DC, 72=PR 不計入
    }));

    const stateOrder = Array.from(stateMeta.keys());

    const projection = d3.geoAlbersUsa();
    const path = d3.geoPath(projection);

    const storeKey = 'us-fill-map-v1';
    let paintMode = 'cycle'; // 'cycle' | 'brush'
    let brushColor = 'blue'; // 'blue' | 'red' | 'neutral'

    function setMode(mode) {
      paintMode = mode;
      d3.select('#modeCycle').classed('primary', mode==='cycle');
      d3.select('#modeBrush').classed('primary', mode==='brush');
    }

    function setBrush(color) {
      brushColor = color;
      ['pickBlue','pickRed','pickNeutral'].forEach(id => d3.select('#'+id).classed('primary', false));
      if (color==='blue') d3.select('#pickBlue').classed('primary', true);
      if (color==='red') d3.select('#pickRed').classed('primary', true);
      if (color==='neutral') d3.select('#pickNeutral').classed('primary', true);
    }

    function updateStats() {
      const states = gStates.selectAll('path.state');
      const blue = states.filter('.blue').size();
      const red = states.filter('.red').size();
      const filled = blue + red;
      d3.select('#blueN').text(blue);
      d3.select('#redN').text(red);
      d3.select('#filledN').text(filled);
    }

    function saveState() {
      const obj = {};
      gStates.selectAll('path.state').each(function(d){
        const el = this;
        const id = d.idStr; // FIPS string like "06"
        if (el.classList.contains('blue')) obj[id] = 'b';
        else if (el.classList.contains('red')) obj[id] = 'r';
      });
      try { localStorage.setItem(storeKey, JSON.stringify(obj)); } catch {}
    }

    function loadState() {
      let obj = {};
      try { obj = JSON.parse(localStorage.getItem(storeKey) || '{}'); } catch {}
      gStates.selectAll('path.state').each(function(d){
        const el = this;
        el.classList.remove('blue','red');
        const s = obj[d.idStr];
        if (s==='b') el.classList.add('blue');
        if (s==='r') el.classList.add('red');
      });
      updateStats();
    }

    function clearAll() {
      gStates.selectAll('path.state').classed('blue', false).classed('red', false);
      saveState();
      updateStats();
    }

    function showTooltip(html, [x,y]) {
      tooltip.style('display','block').html(html).style('left', x+"px").style('top', y+"px");
    }
    function hideTooltip() { tooltip.style('display','none'); }

    function toggleLabels() {
      const cur = gLabels.style('display') !== 'none';
      gLabels.style('display', cur ? 'none' : null);
      d3.select('#labelsBtn').classed('primary', !cur);
    }

    function labelFor(feature) {
      const meta = stateMeta.get(feature.idStr);
      return meta ? meta.abbr : '';
    }

    function colorState(el, how) {
      el.classList.remove('blue','red');
      if (how==='blue') el.classList.add('blue');
      if (how==='red') el.classList.add('red');
    }

    function cycleState(el) {
      if (el.classList.contains('blue')) { colorState(el,'red'); }
      else if (el.classList.contains('red')) { colorState(el,'neutral'); }
      else { colorState(el,'blue'); }
    }

    function exportPNG() {
      const svgNode = document.getElementById('svg');
      const serializer = new XMLSerializer();
      const src = serializer.serializeToString(svgNode);
      const svgBlob = new Blob([src], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ratio = 960/600; // viewBox size
        const W = Math.min(window.innerWidth*2, 1920);
        const H = Math.round(W/ratio);
        canvas.width = W; canvas.height = H;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#0d111a';
        ctx.fillRect(0,0,W,H);
        ctx.drawImage(img, 0, 0, W, H);
        canvas.toBlob((blob)=>{
          const a = document.createElement('a');
          a.download = 'us-map-fill.png';
          a.href = URL.createObjectURL(blob);
          a.click();
          URL.revokeObjectURL(url);
        });
      };
      img.src = url;
    }

    // Load map
    fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json')
      .then(r => r.json())
      .then(us => {
        const states = topojson.feature(us, us.objects.states).features
          .filter(f => stateMeta.has(String(f.id).padStart(2,'0'))); // 保留 50 州，排除 DC 與屬地

        // Fit projection
        projection.fitSize([920, 560], {type:'FeatureCollection', features: states});

        // Draw states
        const paths = gStates.selectAll('path').data(states, d=>d.id);
        paths.enter().append('path')
          .attr('class','state')
          .attr('d', d => path(d))
          .each(function(d){ d.idStr = String(d.id).padStart(2,'0'); this.dataset.fips = d.idStr; })
          .on('pointerenter', function(event, d){
            const meta = stateMeta.get(d.idStr) || {}; const ab = meta.abbr || '';
            showTooltip(`${meta.name || '未知'} (${ab})`, [event.clientX, event.clientY]);
          })
          .on('pointermove', function(event){
            showTooltip(tooltip.html(), [event.clientX, event.clientY]);
          })
          .on('pointerleave', function(){ hideTooltip(); })
          .on('contextmenu', function(event){ event.preventDefault(); colorState(this,'neutral'); saveState(); updateStats(); })
          .on('click', function(){
            if (paintMode==='cycle') cycleState(this); else colorState(this, brushColor);
            saveState(); updateStats();
          });

        // Labels
        const labels = gLabels.selectAll('text').data(states, d=>d.id);
        labels.enter().append('text')
          .attr('class','label')
          .text(d => labelFor(d))
          .attr('transform', d => `translate(${path.centroid(d)})`)
          .attr('dy', '0.35em');

        loadState();
      });

    // Controls
    document.getElementById('modeCycle').addEventListener('click', ()=> setMode('cycle'));
    document.getElementById('modeBrush').addEventListener('click', ()=> setMode('brush'));
    document.getElementById('pickBlue').addEventListener('click', ()=> setBrush('blue'));
    document.getElementById('pickRed').addEventListener('click',  ()=> setBrush('red'));
    document.getElementById('pickNeutral').addEventListener('click', ()=> setBrush('neutral'));
    document.getElementById('resetBtn').addEventListener('click', clearAll);
    document.getElementById('labelsBtn').addEventListener('click', toggleLabels);
    document.getElementById('exportBtn').addEventListener('click', exportPNG);

    // Shortcuts
    window.addEventListener('keydown', (e)=>{
      if (e.key==='l' || e.key==='L') toggleLabels();
      if (e.key==='b' || e.key==='B') { setMode('brush'); setBrush('blue'); }
      if (e.key==='r' || e.key==='R') { setMode('brush'); setBrush('red'); }
      if (e.key==='n' || e.key==='N') { setMode('brush'); setBrush('neutral'); }
    });

    // Init UI
    setMode('cycle');
    setBrush('blue');
  })();
  </script>
</body>
</html>
